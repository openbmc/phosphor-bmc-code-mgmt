{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "92dd4fec_6aa07232",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 13,
      "author": {
        "id": 1001853
      },
      "writtenOn": "2025-07-17T17:00:34Z",
      "side": 1,
      "message": "I posted the test results in a Discord thread:\nhttps://discord.com/channels/775381525260664832/867820390406422538/threads/1395349728459231316\n\nDuring testing `phosphor-image-updater` crashes with the following errors:\n1) `std::bad_alloc` -\u003e sigabrt;\n2) segfault.",
      "revId": "39185940245b38e045f03f9abbbd4d22ef816fd0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c41da776_c1c739fd",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 13,
      "author": {
        "id": 1001758
      },
      "writtenOn": "2025-07-17T18:25:15Z",
      "side": 1,
      "message": "1. @striker_1993@mail.ru I would suggest NOT to make any changes to repo versions but just take the one\u0027s which are in openbmc/openbmc and use this patch and see how it goes. Did u test with this combination?\n2. Also for your testing can please add a info log before this-\u003eparent.erase(this-\u003eversionId); to see if it actually gets called. Also you can add and check the logs in https://github.com/openbmc/phosphor-bmc-code-mgmt/blob/master/bmc/item_updater.cpp#L490 erase function and see what flow is it going through?",
      "parentUuid": "92dd4fec_6aa07232",
      "revId": "39185940245b38e045f03f9abbbd4d22ef816fd0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f4c23cc3_4e7d00e0",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 13,
      "author": {
        "id": 1001853
      },
      "writtenOn": "2025-07-18T16:30:19Z",
      "side": 1,
      "message": "1. Yes.\nThis revision: https://github.com/openbmc/openbmc/commit/0fc8d76b76\nAnd applied your patch.\n\n2. Changes and logs are below.",
      "parentUuid": "c41da776_c1c739fd",
      "revId": "39185940245b38e045f03f9abbbd4d22ef816fd0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f5325ae6_530a5f86",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 13,
      "author": {
        "id": 1001853
      },
      "writtenOn": "2025-07-18T16:44:45Z",
      "side": 1,
      "message": "```\ndiff --git a/bmc/activation.cpp b/bmc/activation.cpp\nindex 5cbeed5..3d009ea 100644\n--- a/bmc/activation.cpp\n+++ b/bmc/activation.cpp\n@@ -447,8 +447,11 @@ void Activation::onStateChangesBios(sdbusplus::message_t\u0026 msg)\n             parent.biosVersion-\u003eversion(\n                 parent.versions.find(versionId)-\u003esecond-\u003eversion());\n \n+            error(\"[DEBUG] Outside coro\");\n             // Delete the uploaded activation\n             ctx.spawn([this]() -\u003e sdbusplus::async::task\u003c\u003e {\n+                error(\"[DEBUG] Inside coro\");\n+                //error(\"[DEBUG] Inside coro: versionId\u003d{ID}\", \"ID\", this-\u003eversionId);\n                 this-\u003eparent.erase(this-\u003eversionId);\n                 co_return;\n             }());\ndiff --git a/bmc/item_updater.cpp b/bmc/item_updater.cpp\nindex 6320158..0974fe7 100644\n--- a/bmc/item_updater.cpp\n+++ b/bmc/item_updater.cpp\n@@ -489,8 +489,10 @@ void ItemUpdater::processBMCImage()\n \n void ItemUpdater::erase(std::string entryId)\n {\n+    error(\"[DEBUG] Inside erase(): arg\u003d{ID}\", \"ID\", entryId);\n     // Find entry in versions map\n     auto it \u003d versions.find(entryId);\n+    error(\"[DEBUG] Inside erase(): step1\");\n     if (it !\u003d versions.end())\n     {\n         if (it-\u003esecond-\u003eisFunctional() \u0026\u0026 ACTIVE_BMC_MAX_ALLOWED \u003e 1)\n\n```\n\nLog:\n\n```\nJul 18 19:01:25 openbmc phosphor-image-updater[12979]: BMC activation has ended - BMC reboots are re-enabled.\nJul 18 19:01:25 openbmc phosphor-image-updater[12979]: Bios upgrade completed successfully.\nJul 18 19:01:25 openbmc phosphor-image-updater[12979]: [DEBUG] Outside coro\nJul 18 19:01:25 openbmc phosphor-image-updater[12979]: [DEBUG] Inside coro\nJul 18 19:01:25 openbmc phosphor-image-updater[12979]: [DEBUG] Inside erase(): arg\u003d\nJul 18 19:01:26 openbmc systemd[1]: Starting Removes the guard that blocks BMC reboot...\nJul 18 19:01:26 openbmc systemd-coredump[15000]: Process 12979 (phosphor-image-) of user 0 terminated abnormally with signal 11/SEGV, processing...\n\n```\n\nIf uncomment line 554 (this is the commented out error() call) \u003d\u003d attempt to access `this-\u003eversionId`):\n\n```\nJul 18 19:07:14 aqc621ab phosphor-image-updater[18570]: BMC activation has ended - BMC reboots are re-enabled.\nJul 18 19:07:14 aqc621ab phosphor-image-updater[18570]: Bios upgrade completed successfully.\nJul 18 19:07:14 aqc621ab phosphor-image-updater[18570]: [DEBUG] Outside coro\nJul 18 19:07:14 aqc621ab phosphor-image-updater[18570]: [DEBUG] Inside coro\nJul 18 19:07:15 aqc621ab systemd[1]: Starting Removes the guard that blocks BMC reboot...\nJul 18 19:07:15 aqc621ab systemd-coredump[19058]: Process 18570 (phosphor-image-) of user 0 terminated abnormally with signal 11/SEGV, processing...\n\n```",
      "parentUuid": "f4c23cc3_4e7d00e0",
      "revId": "39185940245b38e045f03f9abbbd4d22ef816fd0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3d087192_3f6c89c6",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 13,
      "author": {
        "id": 1001853
      },
      "writtenOn": "2025-07-18T16:47:40Z",
      "side": 1,
      "message": "Also tried this change:\n\n```\ndiff --git a/bmc/activation.cpp b/bmc/activation.cpp\nindex 5cbeed5..4aaeca1 100644\n--- a/bmc/activation.cpp\n+++ b/bmc/activation.cpp\n@@ -447,8 +447,10 @@ void Activation::onStateChangesBios(sdbusplus::message_t\u0026 msg)\n             parent.biosVersion-\u003eversion(\n                 parent.versions.find(versionId)-\u003esecond-\u003eversion());\n \n+            error(\"[DEBUG] Outside coro: this\u003d{ADDR}\", \"ADDR\", this);\n             // Delete the uploaded activation\n             ctx.spawn([this]() -\u003e sdbusplus::async::task\u003c\u003e {\n+                error(\"[DEBUG] Inside coro: this\u003d{ADDR}\", \"ADDR\", this);\n                 this-\u003eparent.erase(this-\u003eversionId);\n                 co_return;\n             }());\ndiff --git a/bmc/item_updater.cpp b/bmc/item_updater.cpp\nindex 6320158..0974fe7 100644\n--- a/bmc/item_updater.cpp\n+++ b/bmc/item_updater.cpp\n@@ -489,8 +489,10 @@ void ItemUpdater::processBMCImage()\n \n void ItemUpdater::erase(std::string entryId)\n {\n+    error(\"[DEBUG] Inside erase(): arg\u003d{ID}\", \"ID\", entryId);\n     // Find entry in versions map\n     auto it \u003d versions.find(entryId);\n+    error(\"[DEBUG] Inside erase(): step1\");\n     if (it !\u003d versions.end())\n     {\n         if (it-\u003esecond-\u003eisFunctional() \u0026\u0026 ACTIVE_BMC_MAX_ALLOWED \u003e 1)\n\n```\n\nLog:\n\n```\nJul 18 19:12:02 openbmc phosphor-image-updater[21441]: BMC activation has ended - BMC reboots are re-enabled.\nJul 18 19:12:02 openbmc phosphor-image-updater[21441]: Bios upgrade completed successfully.\nJul 18 19:12:02 openbmc phosphor-image-updater[21441]: terminate called after throwing an instance of \u0027std::length_error\u0027\nJul 18 19:12:02 openbmc phosphor-image-updater[21441]:   what():  basic_string::_M_create\nJul 18 19:12:02 openbmc phosphor-image-updater[21441]: [DEBUG] Outside coro: this\u003d0x75a05308\nJul 18 19:12:02 openbmc phosphor-image-updater[21441]: [DEBUG] Inside coro: this\u003d0x00c89ea8\nJul 18 19:12:02 openbmc systemd[1]: Starting Removes the guard that blocks BMC reboot...\nJul 18 19:12:03 openbmc systemd-coredump[21982]: Process 21441 (phosphor-image-) of user 0 terminated abnormally with signal 6/ABRT, processing...\n```",
      "parentUuid": "f5325ae6_530a5f86",
      "revId": "39185940245b38e045f03f9abbbd4d22ef816fd0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b60173eb_def39d4d",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 13,
      "author": {
        "id": 1001758
      },
      "writtenOn": "2025-07-23T22:46:22Z",
      "side": 1,
      "message": "\u003e Jul 18 19:12:02 openbmc phosphor-image-updater[21441]: terminate called after throwing an instance of \u0027std::length_error\u0027\n\u003e Jul 18 19:12:02 openbmc phosphor-image-updater[21441]:   what():  basic_string::_M_create\n\nLooks like something wrong with the versionId. Can you try printing it before lambda and check the value? I don\u0027t think activation object shall go out of scope until its erased but we need to see why correct versionId/entryId is not being passed. \n\n\nAlso going back to the original issue you mentioned on discord -\n\n\u003e ```\n\u003e Since boost::asio::io_context is not run, the downloaded activation will not be deleted, resulting in \"no free space\" after 3-4 iterations.\n\u003e Should it be fixed with sdbusplus::async::context spawn()?\n\u003e ```\n\nAre you running out of flash memory?",
      "parentUuid": "3d087192_3f6c89c6",
      "revId": "39185940245b38e045f03f9abbbd4d22ef816fd0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b9c25045_1c0bcd43",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 13,
      "author": {
        "id": 1001526
      },
      "writtenOn": "2025-07-28T02:51:57Z",
      "side": 1,
      "message": "There must be issue with the lambda capture. The below implementation works on my platform, can you also try it?\n\n```\nctx.spawn([](auto self) -\u003e sdbusplus::async::task\u003c\u003e {\n    self-\u003eparent.erase(self-\u003eversionId);\n    co_return;\n}(this));\n```",
      "parentUuid": "b60173eb_def39d4d",
      "revId": "39185940245b38e045f03f9abbbd4d22ef816fd0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2d1ae64e_0a0c9599",
        "filename": "bmc/activation.cpp",
        "patchSetId": 1
      },
      "lineNbr": 451,
      "author": {
        "id": 1002582
      },
      "writtenOn": "2025-07-28T08:16:29Z",
      "side": 1,
      "message": "Hi @paligill@gmail.com\nAs @chaul@amperecomputing.com suggested, using the below lambda function call the erase function correctly.\n```\nctx.spawn([](auto self) -\u003e sdbusplus::async::task\u003c\u003e {\n    self-\u003eparent.erase(self-\u003eversionId);\n    co_return;\n}(this));\n```\nBut eventhough calling the erase function it is not erasing the files under /tmp/images directory. Not sure the intended functionality of erase function. It seems it needs to implement a logic to delete the files under /tmp/images in erase function.",
      "revId": "39185940245b38e045f03f9abbbd4d22ef816fd0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "87834c37_d7340d08",
        "filename": "bmc/activation.cpp",
        "patchSetId": 1
      },
      "lineNbr": 451,
      "author": {
        "id": 1001758
      },
      "writtenOn": "2025-07-29T07:56:05Z",
      "side": 1,
      "message": "@anoo@us.ibm.com  Looks like ImageManager was the one to delete the images from /tmp/images dir https://grok.openbmc.org/xref/openbmc/phosphor-bmc-code-mgmt/bmc/image_manager.cpp?r\u003dcab87e9cdeeb3e166d6d577511f6be4dc7721aca#243. Do you know how item_updater used to call back into it or is it some other flow.\n\nPS: This is for bios update (not BMC).",
      "parentUuid": "2d1ae64e_0a0c9599",
      "revId": "39185940245b38e045f03f9abbbd4d22ef816fd0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    }
  ]
}